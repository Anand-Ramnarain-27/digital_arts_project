<meta name="monetization" content="$twitter.xrptipbot.com/remvst"><title>My Game</title><style>/* *{margin:0;width:100%;height:100%;background:#000;position:relative}#t{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}#g{display:block} */</style><div id="t"><canvas id="g"></canvas></div><script src="//game-cdn.poki.com/scripts/v2/poki-sdk.js"></script><script>function revertOptimizeMatrix(t,e,i){const s=[],l=Array(e).fill(1);s.push(l);for(let i=0;i<t-2;i++){const t=[];t.length=e,t[0]=1,t[e-1]=1,s.push(t)}return s.push(l),i.forEach(t=>{let[e,i,l,a]=t,r=!!l,n=!!a;for(let t=0;t<max(l,a);t++)s[e+t*r][i+t*n]=1}),s}let R,G,W,P,w=window,onMenu=1,CANVAS=g;limit=((t,e,i)=>e<t?t:e>i?i:e),between=((t,e,i)=>e>=t&&e<=i),rnd=((t,e)=>random()*(e-t)+t),pick=(t=>t[~~(random()*t.length)]),distP=((t,e,i,s)=>sqrt(pow(t-i,2)+pow(e-s,2))),dist=((t,e)=>distP(t.x,t.y,e.x,e.y)),normalize=(t=>moduloWithNegative(t,PI)),angleBetween=((t,e)=>atan2(e.y-t.y,e.x-t.x)),roundToNearest=((t,e)=>round(t/e)*e),moduloWithNegative=((t,e)=>((t%=2*e)>e&&(t-=2*e),t<-e&&(t+=2*e),t));let math=Math;Object.getOwnPropertyNames(math).forEach(t=>w[t]=w[t]||math[t]),TWO_PI=2*PI;let canvasProto=CanvasRenderingContext2D.prototype;canvasProto.wrap=function(t){this.save(),t(),this.restore()},canvasProto.fr=canvasProto.fillRect,canvasProto.fs=function(t){this.fillStyle=t},canvasProto.roundedRectangle=function(t,e,i,s,l){PI;let a=2*PI/2,r=2*PI/4;this.arc(l+t,l+e,l,-r,a,1),this.arc(l+t,s-l+e,l,a,r,1),this.arc(t+i-l,e+s-l,l,r,0,1),this.arc(t+i-l,e+l,l,0,-r,1)},onresize=(()=>{var e,i,s=innerWidth,l=innerHeight,a=s/l,r=t.style;a<=2?i=(e=s)/2:e=2*(i=l),r.width=e+"px",r.height=i+"px"}),linear=(t=>t),easeOutQuad=(t=>t*(2-t)),easeOutQuint=(t=>1+--t*t*t*t*t),easeInQuint=(t=>t*t*t*t*t),interp=((t,e,i,s,l,a,r,n)=>{let h={o:t,p:e,a:i,b:s,d:l,l:a||0,f:r||linear,e:n||(()=>0),t:0,cycle:t=>{if(h.l>0)h.l-=t,h.o[h.p]=h.a;else if(h.t=min(h.d,h.t+t),h.o[h.p]=h.f(h.t/h.d)*(h.b-h.a)+h.a,h.t==h.d){h.e();let t=INTERPOLATIONS.indexOf(h);t>=0&&INTERPOLATIONS.splice(t,1)}}};INTERPOLATIONS.push(h)}),INTERPOLATIONS=[],castRay=((t,e,i,s)=>{let l,a=castAgainstHorizontal(t,e,i,s),r=castAgainstVertical(t,e,i,s);if(a)if(r){l=distP(t,e,a.x,a.y)<distP(t,e,r.x,r.y)?a:r}else l=a;else l=r;return distP(t,e,l.x,l.y)>s&&(l={x:t+cos(i)*s,y:e+sin(i)*s}),l}),castAgainstHorizontal=((t,e,i,s)=>{var l=sin(i)>0,a=40*~~(e/40)+(l?40:-1e-4),r=t+(a-e)/tan(i),n=l?40:-40,h=n/tan(i);return doCast(r,a,h,n,1,s)}),castAgainstVertical=((t,e,i,s)=>{var l=cos(i)>0,a=40*~~(t/40)+(l?40:-1e-4),r=e+(a-t)*tan(i),n=l?40:-40,h=n*tan(i);return doCast(a,r,n,h,0,s)}),doCast=((t,e,i,s,l,a)=>{let r=t,n=e;for(let h=0;distP(r,n,t,e)<a;h++){if(internalHasBlock(r,n)){let t=~~(r/40)+~~(n/40)*G.level.definition.matrix.length;return{x:r,y:n,castType:l+"-"+t,blockId:t}}if(isOut(r,n))break;r+=i,n+=s}return{x:r,y:n,castType:""}}),hasBlock=((t,e,i=0)=>internalHasBlock(t,e)||internalHasBlock(t-i,e-i)||internalHasBlock(t-i,e+i)||internalHasBlock(t+i,e-i)||internalHasBlock(t+i,e+i)),internalHasBlock=((t,e)=>!isOut(t,e)&&G.level.definition.matrix[~~(e/40)][~~(t/40)]),isOut=((t,e)=>!between(0,t,40*G.level.definition.matrix[0].length-1)||!between(0,e,40*G.level.definition.matrix.length-1)),toCellUnit=(t=>~~(t/40)),remove=((t,e)=>{let i=t.indexOf(e);i>=0&&t.splice(i,1)});class PointRenderable{constructor(t,e,i,s){this.x=t,this.y=e,this.radius=i,this.color=s}render(){R.fillStyle=this.color,fr(this.x-this.radius,this.y-this.radius,2*this.radius,2*this.radius)}}createNumberGenerator=(t=>{let e=new Uint32Array([imul(t,2246822507),imul(t,3266489909)]),i=()=>{let t=e[0],i=e[1]^t;return e[0]=(t<<26|t>>8)^i^i<<9,e[1]=i<<13|i>>19,(imul(t,2654435771)>>>0)/4294967295};return{pick:t=>t[~~(i()*t.length)],between:(t,e)=>i()*(e-t)+t,floating:i}});let createCanvas=(t,e,i)=>{let s=document.createElement("canvas");return s.width=t,s.height=e,i(s.getContext("2d"),s)||s},createCanvasPattern=(t,e,i)=>{let s=createCanvas(t,e,i);return s.getContext("2d").createPattern(s,"repeat")};padCanvas=((t,e,i,s)=>createCanvas(40*e,40*t,(t,e)=>{let l;l=e.height*i-s.height*i,t.drawImage(s,(e.width-s.width)/2,l)})),SKY_BACKGROUND=createCanvasPattern(200,800,t=>{let e=t.createLinearGradient(0,0,0,800);e.addColorStop(0,"#000"),e.addColorStop(.7,"#000"),e.addColorStop(1,"#000"),t.fillStyle=e,t.fr(0,0,200,800)}),GOD_RAY=createCanvas(24,160,(t,e)=>{let i=t.createLinearGradient(0,0,0,160);i.addColorStop(0,"rgba(255,255,255, 0)"),i.addColorStop(.5,"rgba(255,255,255, 0.5)"),i.addColorStop(1,"rgba(255,255,255, 0)"),t.fillStyle=i,t.fillRect(0,0,99,999)}),HALO=createCanvas(160,160,(t,e)=>{let i=t.createRadialGradient(e.width/2,e.height/2,0,e.width/2,e.height/2,e.width/2);i.addColorStop(.5,"rgba(255,255,255, 0.5)"),i.addColorStop(1,"rgba(255,255,255, 0)"),t.fillStyle=i,t.fillRect(0,0,999,999)}),COMPUTER=createCanvas(24,24,(t,e)=>{t.fillStyle="#1a1a1a",t.fr(0,0,99,99),t.fillStyle="#2b2b2b",t.fr(2,2,e.width-4,e.height-4),t.fillStyle="#0a0a0a",t.fr(4,4,e.width-8,e.height-12),t.fillStyle="#3333ff",t.fr(4,e.height-6,e.width-8,2),t.fillStyle="#00ff00",t.fr(e.width-6,e.height-6,2,2)}),WINDOW_PATTERN=createCanvasPattern(80,80,(t,e)=>{t.fillStyle="#8c9bee",t.fillRect(0,0,999,999),t.fillStyle="#f29afb",t.fillRect(e.width/4,e.height/4,e.width/2,e.width/2)}),BUILDINGS_BACKGROUND=createCanvasPattern(800,400,(t,e)=>{t.fillStyle=WINDOW_PATTERN,t.fillRect(0,0,e.width,e.height)}),UNPADDED_DESK=createCanvas(44,20,(t,e)=>{t.fillStyle="#000",t.fillRect(2,0,2,e.height),t.fillRect(e.width-2,0,-2,e.height),t.fillStyle="#494742",t.fillRect(0,0,99,4),t.fillStyle="#ccc",t.fillRect(4,4,e.width/4,e.height/3),t.fillRect(e.width-4,4,-e.width/4,e.height/3)}),DESK=padCanvas(1,2,1,UNPADDED_DESK),LEVEL_BACKGROUND=createCanvasPattern(160,240,(t,e)=>{t.fillStyle="#29c2fd",t.fr(0,0,e.width,e.height),t.fillStyle="#000",t.globalAlpha=.05,t.fr(0,0,e.width,2),t.fr(0,120,e.width,2),t.fr(0,0,2,120),t.fr(80,120,2,400)}),createLevelBackground=(t=>createCanvas(800,800,(e,i)=>{e.fillStyle=LEVEL_BACKGROUND,e.fr(0,0,i.width,i.height);let s=createNumberGenerator(1),l=t.definition.matrix.map(t=>t.slice());l[t.definition.exit[0]][t.definition.exit[1]]=1;let a=[];for(let t=1;t<19;t++)for(let i=1;i<19;i++){if(l[t][i])continue;let s=s=>()=>{for(let e=0;e<s.height/40;e++)for(let a=0;a<s.width/40;a++)if(l[t+e][i+a])return;for(let e=0;e<s.height/40;e++)for(let a=0;a<s.width/40;a++)l[t+e][i+a]=1;e.drawImage(s,40*i,40*t)},r=(l[t][i],l[t][i+1]),n=l[t+1][i],h=(l[t-1][i],l[t+2]&&l[t+2][i],l[t+1][i+1]),o=[];n&&!r&&h&&o.push(s(DESK)),o.length&&a.push(o)}a.flat().forEach(t=>{s.floating()<.15&&t()})}));class Particle{constructor(t){let e=t.duration||1;this.color=t.color||"#f00";let i=t.size||[5,5],s=t.alpha||[1,-1];interp(this,"x",t.x[0],t.x[0]+t.x[1],e),interp(this,"y",t.y[0],t.y[0]+t.y[1],e),interp(this,"alpha",s[0],s[0]+s[1],e),interp(this,"size",i[0],i[0]+(i[1]||0),e,0,0,t.onFinish)}render(){R.globalAlpha=this.alpha,fs(this.color),beginPath(),arc(this.x,this.y,this.size/2,0,TWO_PI),fill()}}class Menu{constructor(t,e){this.title=t,this.subtitle=e,this.titlePosition=this.subtitlePosition=9999,this.dimAlpha=0}animateIn(){interp(this,"titlePosition",-400,400,.5,0,easeOutQuint),interp(this,"subtitlePosition",1200,400,.5,1,easeOutQuint),interp(this,"dimAlpha",0,1,.3)}animateOut(){interp(this,"titlePosition",400,1200,.5,0,easeInQuint),interp(this,"subtitlePosition",400,-400,.5,0,easeInQuint,()=>G.menu=0),interp(this,"dimAlpha",1,0,.3,.2)}cycle(t){}render(){translate(400,0),beginPath(),rect(0,0,800,800),clip(),R.fillStyle="rgba(0,0,0,"+.8*this.dimAlpha+")",fr(0,0,800,800),R.textAlign="center",R.textBaseline="middle",R.fillStyle="#fff",R.font="italic 24pt Impact",fillText(this.title,this.titlePosition,375),R.font="italic 48pt Impact",fillText(this.subtitle,this.subtitlePosition,425)}}renderVision=((t,e,i,s,l,a)=>wrap(()=>{R.fillStyle=R.strokeStyle=a,R.lineWidth=2,R.globalAlpha=.3,beginPath(),moveTo(t,e);for(let a=0;a<=30;a++){let r=a/30*(s-i)+i;a&&a<30&&(r=roundToNearest(r,(s-i)/30));let n=castRay(t,e,r,l);lineTo(n.x,n.y)}closePath(),fill(),stroke()}));class Level{constructor(t,e){this.index=t,this.definition=e,this.windowsAlpha=0,this.stop()}endWith(t){this.ended||(this.ended=1,this.player.controllable=0,t())}foundExit(){this.endWith(()=>{G.menu=new Menu("Infiltrating Core Systems&","Breach Successful"),G.menu.animateIn(),setTimeout(()=>{G.menu.animateOut()},2e3),setTimeout(()=>{G.nextLevel(),interp(this,"windowsAlpha",0,1,.2)},2500)})}wasFound(){this.endWith(()=>{G.menu=new Menu("Breach Unsuccessful","PRESS [R] TO TRY AGAIN"),G.menu.animateIn()})}start(){this.ended=0,interp(this,"windowsAlpha",1,0,.2),this.clock=0,this.cyclables=[],this.renderables=[],this.player=new Player(this,40*(this.definition.spawn[1]+.5),40*(this.definition.spawn[0]+.5)),this.exit=new Exit(this,40*(this.definition.exit[1]+.5),40*(this.definition.exit[0]+.5)),this.cyclables.push(this.exit),this.renderables.push(this.exit),this.definition.cameras.forEach(([t,e,i,s,l,a])=>{let r=new Camera(this,40*(e+.5),40*(t+.5),i,s,l,a);this.cyclables.push(r),this.renderables.push(r)}),setTimeout(()=>{this.player.controllable=1,this.player.spawn(),this.cyclables.push(this.player),this.renderables.push(this.player)},500)}stop(){this.cyclables=[],this.renderables=[]}cycle(t){this.clock+=t,this.cyclables.forEach(e=>e.cycle(t))}render(){R.fillStyle="#29c2fd",R.fillStyle=LEVEL_BACKGROUND,fr(0,0,800,800),this.background=this.background||createLevelBackground(this),drawImage(this.background,0,0),R.fillStyle="rgba(0,0,0,0.2)";for(let t=0;t<20;t++)fr(0,40*t,800,1),fr(40*t,0,1,800);R.textAlign="center",R.textBaseline="middle",R.fillStyle="rgba(255,255,255,0.5)",R.font="italic 24pt Impact";fillText(this.definition.message||"",400,160),this.renderables.forEach(t=>wrap(()=>t.render())),R.fillStyle="#010640";for(let t=0;t<20;t++)for(let e=0;e<20;e++)this.definition.matrix[t][e]&&fr(40*e,40*t,40,40);R.globalAlpha=this.windowsAlpha,R.fillStyle=WINDOW_PATTERN}particle(t){let e;t.onFinish=(()=>remove(this.renderables,e)),this.renderables.push(e=new Particle(t))}}LEVELS=[{matrix:revertOptimizeMatrix(20,20,[[6,13,0,6],[9,7,0,3],[12,12,0,3],[15,7,4,0],[15,8,4,0],[15,9,4,0],[17,5,2,0],[17,6,2,0],[17,10,2,0],[17,11,2,0]]),spawn:[16,2],exit:[5,17],message:"Press [SPACE] to jump",cameras:[[2,2,PI/2,PI/4,1,2]]},{matrix:revertOptimizeMatrix(20,20,[[4,4,1,0],[4,9,0,4],[5,5,1,0],[6,4,1,0],[7,15,0,2],[8,7,0,2],[8,10,1,0],[10,1,0,2],[10,13,0,2],[13,10,0,2],[14,7,3,0],[16,5,0,2]]),spawn:[2,2],exit:[15,17]},{matrix:revertOptimizeMatrix(20,20,[[4,4,1,0],[4,9,0,4],[5,5,1,0],[6,4,1,0],[7,15,0,2],[8,7,0,2],[8,10,1,0],[10,1,0,2],[10,13,0,2],[13,10,0,2],[14,7,3,0],[16,5,0,2]]),spawn:[2,2],exit:[15,17]},{matrix:revertOptimizeMatrix(20,20,[[4,4,1,0],[4,9,0,4],[5,5,1,0],[6,4,1,0],[7,15,0,2],[8,7,0,2],[8,10,1,0],[10,1,0,2],[10,13,0,2],[13,10,0,2],[14,7,3,0],[16,5,0,2]]),spawn:[2,2],exit:[15,17]},{matrix:revertOptimizeMatrix(20,20,[[4,4,1,0],[4,9,0,4],[5,5,1,0],[6,4,1,0],[7,15,0,2],[8,7,0,2],[8,10,1,0],[10,1,0,2],[10,13,0,2],[13,10,0,2],[14,7,3,0],[16,5,0,2]]),spawn:[10,2],exit:[15,17]},{matrix:revertOptimizeMatrix(20,20,[[4,4,1,0],[4,9,0,4],[5,5,1,0],[6,4,1,0],[7,15,0,2],[8,7,0,2],[8,10,1,0],[10,1,0,2],[10,13,0,2],[13,10,0,2],[14,7,3,0],[16,5,0,2]]),spawn:[2,2]},{matrix:revertOptimizeMatrix(20,20,[[4,4,1,0],[4,9,0,4],[5,5,1,0],[6,4,1,0],[7,15,0,2],[8,7,0,2],[8,10,1,0],[10,1,0,2],[10,13,0,2],[13,10,0,2],[14,7,3,0],[16,5,0,2]]),spawn:[2,2]},{matrix:revertOptimizeMatrix(20,20,[[4,4,1,0],[4,9,0,4],[5,5,1,0],[6,4,1,0],[7,15,0,2],[8,7,0,2],[8,10,1,0],[10,1,0,2],[10,13,0,2],[13,10,0,2],[14,7,3,0],[16,5,0,2]]),spawn:[2,2]},{matrix:revertOptimizeMatrix(20,20,[[4,4,1,0],[4,9,0,4],[5,5,1,0],[6,4,1,0],[7,15,0,2],[8,7,0,2],[8,10,1,0],[10,1,0,2],[10,13,0,2],[13,10,0,2],[14,7,3,0],[16,5,0,2]]),spawn:[2,2]},{matrix:revertOptimizeMatrix(20,20,[[4,4,1,0],[4,9,0,4],[5,5,1,0],[6,4,1,0],[7,15,0,2],[8,7,0,2],[8,10,1,0],[10,1,0,2],[10,13,0,2],[13,10,0,2],[14,7,3,0],[16,5,0,2]]),spawn:[2,2]},{matrix:revertOptimizeMatrix(20,20,[[4,4,1,0],[4,9,0,4],[5,5,1,0],[6,4,1,0],[7,15,0,2],[8,7,0,2],[8,10,1,0],[10,1,0,2],[10,13,0,2],[13,10,0,2],[14,7,3,0],[16,5,0,2]]),spawn:[2,2]},{matrix:revertOptimizeMatrix(20,20,[[4,4,1,0],[4,9,0,4],[5,5,1,0],[6,4,1,0],[7,15,0,2],[8,7,0,2],[8,10,1,0],[10,1,0,2],[10,13,0,2],[13,10,0,2],[14,7,3,0],[16,5,0,2]]),spawn:[2,2]},{matrix:revertOptimizeMatrix(20,20,[[4,4,1,0],[4,9,0,4],[5,5,1,0],[6,4,1,0],[7,15,0,2],[8,7,0,2],[8,10,1,0],[10,1,0,2],[10,13,0,2],[13,10,0,2],[14,7,3,0],[16,4,3,0],[16,5,0,2]]),spawn:[2,2]}].map((t,e)=>new Level(e,t));class Player{constructor(t,e,i){this.level=t,this.x=e,this.y=i,this.previous={},this.vX=this.vY=0,this.facing=1,this.walking=0,this.facingScale=1,this.jumpHoldTime=0,this.jumpReleased=1,this.jumpStartY=0,this.jumpEndY=0,this.jumpPeakTime=0,this.controllable=0,this.wasStickingToWallX=0,this.clock=0,this.bandanaTrail=[]}get landed(){let t=this.x-15,e=this.x+15,i=this.y+15+1;return hasBlock(t,i)||hasBlock(e,i)}get sticksToWall(){if(this.landed)return 0;this.wasStickingToWallX,this.x;let t=this.x-15-1,e=this.x+15+1;return hasBlock(t,this.y)&&(w.down[37]||this.wasStickingToWallX)?(this.wasStickingToWallX=this.x,1):hasBlock(e,this.y)&&(w.down[39]||this.wasStickingToWallX)?(this.wasStickingToWallX=this.x,-1):0}cycle(t){let e=t;do{let t=min(e,1/60);e-=t,this.subCycle(t)}while(e>0)}subCycle(t){this.previous.x=this.x,this.previous.y=this.y,this.previous.clock=this.clock,this.previous.facing=this.facing,this.previous.landed=this.landed,this.previous.jumpHoldTime=this.jumpHoldTime,this.clock+=t;let e=down[32]&&this.controllable;if(this.jumpReleased=this.jumpReleased||!e,e?this.jumpHoldTime+=t:this.jumpHoldTime=0,e&&this.jumpReleased&&(this.landed||this.sticksToWall)&&(this.jumpReleased=0,this.jumpStartY=this.y,this.jumpStartTime=this.clock,this.vX+=800*this.sticksToWall),e&&!this.jumpReleased){let t=min(this.jumpHoldTime,.15)/.15,e=20+40*t*3;this.jumpPeakTime=.1+.2*t,this.jumpEndY=this.jumpStartY-e}if(this.clock<this.jumpStartTime+this.jumpPeakTime){let t=(this.clock-this.jumpStartTime)/this.jumpPeakTime;this.y=easeOutQuad(t)*(this.jumpEndY-this.jumpStartY)+this.jumpStartY}else{let e=this.sticksToWall&&this.vY>0?1e3:4e3;this.vY=max(0,this.vY+e*t),this.y+=this.vY*t}let i=0,s=0;this.controllable&&(down[37]&&(i=-1,s=-400),down[39]&&(i=1,s=400)),this.landed&&i&&(this.facing=i),this.facing!=this.previous.facing&&interp(this,"facingScale",-1,1,.1),this.walking=i;let l=this.landed?3e3:1500;if(this.vX+=limit(-l*t,s-this.vX,l*t),this.x+=this.vX*t,this.readjust(),!this.landed&&!this.sticksToWall){let{x:t,y:e}=this,i=createCanvas(80,80,t=>{t.translate(40,40),this.renderCharacter(t)}),s={render:()=>{R.globalAlpha=s.alpha,drawImage(i,t-i.width/2,e-i.height/2)}};this.level.renderables.push(s),interp(s,"alpha",.1,0,.5,.2,0,()=>{remove(this.level.renderables,s)})}if(this.sticksToWall)for(let t=0;t<10;t++)this.level.particle({size:[6],color:"#888",duration:rnd(.4,.8),x:[this.x-15*this.sticksToWall,rnd(-20,20)],y:[this.y+rnd(-15,15),rnd(-20,20)]})}goToClosestAdjustment(t,e){let i,s=999;for(let l=0;l<e.length;l++){let a=dist(t,e[l]);a<s&&(i=e[l],s=a)}return i&&(this.x=i.x,this.y=i.y),i}allSnapAdjustments(){let t=this.x-15,e=this.x+15,i=this.y-15,s=this.y+15,l=toCellUnit(t),a=toCellUnit(e),r=toCellUnit(i),n=toCellUnit(s),h=(hasBlock(t,i),hasBlock(e,i),hasBlock(t,s),hasBlock(e,s),[this.previous.x,this.x]),o=[this.previous.y,this.y];for(let t=l;t<=a;t++)h.push(40*t+15,40*(t+1)-15-1e-4);for(let t=r;t<=n;t++)o.push(40*t+15,40*(t+1)-15-1e-4);return h.flatMap(t=>o.map(e=>({x:t,y:e}))).filter(t=>!hasBlock(t.x,t.y,15))}dust(t){for(let e=0;e<10;e++)this.level.particle({size:[4],color:"#888",duration:rnd(.4,.8),x:[this.x+rnd(-15,15),rnd(-10,10)],y:[t,sign(this.y-t)*rnd(10,5)]})}spawn(){for(let t=0;t<100;t++)this.level.particle({size:[10,-10],color:"#000",duration:rnd(1,2),x:[this.x+1.5*rnd(-15,15),rnd(-20,20)],y:[this.y+1.5*rnd(-15,15),rnd(-20,20)]})}readjust(){let{x:t,y:e}=this,i=this.allSnapAdjustments();this.goToClosestAdjustment(this,i);this.landed?(this.vY=min(0,this.vY),this.previous.landed||(this.dust(this.y+15),this.jumpStartTime=-1)):this.y>e&&(this.dust(this.y-15),this.vY=max(0,this.vY),this.jumpStartTime=-1),this.x!=t&&sign(this.x-t)!=this.facing&&(this.vX=0)}renderCharacter(t){t.fillStyle="red";t.fillRect(-15,-15,30,30)}render(){let t=40;for(let e=1;e<this.bandanaTrail.length&&t>0;e++){let i=this.bandanaTrail[e],s=this.bandanaTrail[e-1],l=dist(i,s),a=min(l,t);t-=a;let r=a/l;lineTo(s.x+r*(i.x-s.x),s.y+r*(i.y-s.y))}stroke(),wrap(()=>{translate(this.x,this.y),this.renderCharacter(R)});R.strokeStyle="#f00",R.fillStyle="#f00",R.globalAlpha=.2,R.lineWidth=5,beginPath();for(let t=0;t<2*PI;t+=PI/16){let e=castRay(this.x,this.y,t,400);lineTo(e.x,e.y)}}}class Exit{constructor(t,e,i){this.level=t,this.x=e,this.y=i}cycle(t){this.level.player&&dist(this,this.level.player)<20&&this.level.foundExit()}render(){wrap(()=>{translate(this.x,this.y),drawImage(HALO,-HALO.width/2,-HALO.height/2),[G.clock*PI,-G.clock*PI/2,G.clock*PI/4].forEach(t=>{wrap(()=>{rotate(t),drawImage(GOD_RAY,-GOD_RAY.width/2,-GOD_RAY.height/2)})})});let t=COMPUTER.height+UNPADDED_DESK.height,e=toCellUnit(this.y);translate(this.x,40*(e+1)-t),drawImage(COMPUTER,-COMPUTER.width/2,0),drawImage(UNPADDED_DESK,-UNPADDED_DESK.width/2,COMPUTER.height)}}class Camera{constructor(t,e,i,s,l,a,r){this.level=t,this.x=e,this.y=i,this.cycleDescription=[[s,s,a],[s,l,r],[l,l,a],[l,s,r]];let n=0;this.cycleDescription.forEach(t=>{t.push(n),n+=t[2]}),this.totalCycleDuration=n}cycle(t){let e=this.level.clock%this.totalCycleDuration,i=this.cycleDescription.length-1;for(;this.cycleDescription[i][3]>e;)i--;let[s,l,a,r]=this.cycleDescription[i],n=(e-r)/a,h=normalize(angleBetween(this,this.level.player));this.foundPlayer?this.angle=h:this.angle=n*(l-s)+s,this.foundPlayer=this.foundPlayer||this.seesPlayer,this.foundPlayer&&this.level.wasFound()}get seesPlayer(){let t=normalize(angleBetween(this,this.level.player)),e=dist(this,this.level.player);if(abs(normalize(this.angle-t))>.4||e>400)return 0;{let i=castRay(this.x,this.y,t,400);return dist(this,i)>=e}}render(){renderVision(this.x,this.y,this.angle-.4,this.angle+.4,400,this.foundPlayer?"#f00":"#ff0"),wrap(()=>{translate(this.x,this.y),rotate(this.angle),fs("#888"),fr(-10,-5,20,10),fs("#444"),fr(10,-2,4,4),fs(this.level.clock%2>1?"#f00":"#0f0"),fr(6,-3,2,2)})}}function SfxrParams(){this.setSettings=function(t){for(var e=0;e<24;e++)this[String.fromCharCode(97+e)]=t[e]||0;this.c<.01&&(this.c=.01);var i=this.b+this.c+this.e;if(i<.18){var s=.18/i;this.b*=s,this.c*=s,this.e*=s}}}function SfxrSynth(){var t,e,i,s,l,a,r,n,h,o,c,d;this._params=new SfxrParams,this.resetManglable=function(){var t=this._params;s=100/(t.f*t.f+.001),l=100/(t.g*t.g+.001),a=1-t.h*t.h*t.h*.01,r=-t.i*t.i*t.i*1e-6,t.a||(c=.5-t.n/2,d=5e-5*-t.o),n=1+t.l*t.l*(t.l>0?-.9:10),h=0,o=1==t.m?0:(1-t.m)*(1-t.m)*2e4+32},this.totalReset=function(){this.resetManglable();var s=this._params;return t=s.b*s.b*1e5,e=s.c*s.c*1e5,i=s.e*s.e*1e5+12,3*((t+e+i)/3|0)},this.synthWave=function(f,u){var p=this._params,m=1!=p.s||p.v,y=p.v*p.v*.1,x=1+3e-4*p.w,v=p.s*p.s*p.s*.1,w=1+1e-4*p.t,g=1!=p.s,S=p.x*p.x,b=p.g,P=p.q||p.r,R=p.r*p.r*p.r*.2,k=p.q*p.q*(p.q<0?-1020:1020),T=p.p?32+((1-p.p)*(1-p.p)*2e4|0):0,A=p.d,C=p.j/2,O=p.k*p.k*.01,E=p.a,j=t,I=1/t,D=1/e,L=1/i,N=5/(1+p.u*p.u*20)*(.01+v);N>.8&&(N=.8),N=1-N;for(var G,B,W,z,M,U,Y=0,_=0,H=0,V=0,K=0,X=0,Q=0,q=0,F=0,J=0,Z=0,$=new Array(1024),tt=new Array(32),et=$.length;et--;)$[et]=0;for(et=tt.length;et--;)tt[et]=rnd(-1,1);for(et=0;et<u;et++){if(Y)return et;if(T&&++J>=T&&(J=0,this.resetManglable()),o&&++h>=o&&(o=0,s*=n),(s*=a+=r)>l&&(s=l,b>0&&(Y=1)),B=s,C>0&&(B*=1+sin(Z+=O)*C),(B|=0)<8&&(B=8),E||((c+=d)<0?c=0:c>.5&&(c=.5)),++H>j)switch(H=0,++_){case 1:j=e;break;case 2:j=i}switch(_){case 0:V=H*I;break;case 1:V=1+2*(1-H*D)*A;break;case 2:V=1-H*L;break;case 3:V=0,Y=1}P&&((W=0|(k+=R))<0?W=-W:W>1023&&(W=1023)),m&&x&&((y*=x)<1e-5?y=1e-5:y>.1&&(y=.1)),U=0;for(var it=8;it--;){if(++q>=B&&(q%=B,3==E))for(var st=tt.length;st--;)tt[st]=rnd(-1,1);switch(E){case 0:M=q/B<c?.5:-.5;break;case 1:M=1-q/B*2;break;case 2:M=.225*(((M=1.27323954*(z=6.28318531*((z=q/B)>.5?z-1:z))+.405284735*z*z*(z<0?1:-1))<0?-1:1)*M*M-M)+M;break;case 3:M=tt[abs(32*q/B|0)]}m&&(G=Q,(v*=w)<0?v=0:v>.1&&(v=.1),g?(X+=(M-Q)*v,X*=N):(Q=M,X=0),K+=(Q+=X)-G,M=K*=1-y),P&&($[F%1024]=M,M+=$[(F-W+1024)%1024],F++),U+=M}U*=.125*V*S,f[et]=U>=1?32767:U<=-1?-32768:32767*U|0}return u}}var synth=new SfxrSynth,jsfxr=function(t){synth._params.setSettings(t);var e=synth.totalReset(),i=new Uint8Array(4*((e+1)/2|0)+44),s=2*synth.synthWave(new Uint16Array(i.buffer,44),e),l=new Uint32Array(i.buffer,0,44);l[0]=1179011410,l[1]=s+36,l[2]=1163280727,l[3]=544501094,l[4]=16,l[5]=65537,l[6]=44100,l[7]=88200,l[8]=1048578,l[9]=1635017060,l[10]=s,s+=44;for(var a=0,r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",n="data:audio/wav;base64,";a<s;a+=3){var h=i[a]<<16|i[a+1]<<8|i[a+2];n+=r[h>>18]+r[h>>12&63]+r[h>>6&63]+r[63&h]}var o=new Audio;return o.src=n,o};jumpSound=jsfxr([0,,.1434,,.1212,.4471,,.2511,,,,,,.0426,,,,,.8862,,,,,.5]),hitSound=jsfxr([1,,.0713,,.1467,.5483,,-.4465,,,,,,,,,,,1,,,.0639,,.5]),pickupSound=jsfxr([0,,.0224,.441,.1886,.6932,,,,,,,,,,,,,1,,,,,.5]),spawnSound=jsfxr([2,.28,.45,,.56,.35,,.4088,,,,,.03,.1557,,.5565,-.02,-.02,1,,,,,.5]),explosionSound=jsfxr([3,,.244,.6411,.2242,.7416,,-.2717,,,,.0171,.0346,,,,-.0305,.0244,1,,,.0275,-.0076,.5]),menuSound=jsfxr([0,,.1394,,.0864,.48,,,,,,,,.5326,,,,,1,,,.1,,.5]),saySound=jsfxr([2,.03,.1,.14,.25,.54,.3167,-.02,.3999,,.05,,,.1021,.0684,,.1287,-.1816,1,,,,,.46]),landSound=jsfxr([3,,.0118,.03,.1681,.565,,-.2343,,,,.26,.6855,,,,,,1,,,,,.2]),fixedSound=jsfxr([0,,.2098,,.4725,.3665,,.1895,,,,,,.0067,,.5437,,,1,,,,,.45]),w.down={},onkeydown=(t=>{w.down[t.keyCode]=1}),onkeyup=(t=>{w.down[t.keyCode]=0});class Game{constructor(){(G=this).clock=0,this.altitude=0,this.level=LEVELS[0],this.startLevel(this.level)}cycle(t){this.clock+=t,this.level.cycle(t),INTERPOLATIONS.slice().forEach(e=>e.cycle(t)),this.menu&&this.menu.cycle(t),this.render()}nextLevel(){this.level.stop(),this.startLevel(LEVELS[this.level.index+1])}startLevel(t){this.level=t,this.centerLevel(this.level),this.level.start()}centerLevel(t){interp(this,"altitude",this.altitude,this.levelY(t)-0,.5)}levelY(t){return 800-800*t.index-0-800}render(){R.fillStyle=SKY_BACKGROUND,fr(0,0,1600,800),R.fillStyle="#fff",beginPath(),arc(1400,100,50,0,2*PI,1),fill(),wrap(()=>{translate(0,-this.altitude),R.fillStyle="#000",fr(400,0,800,800);let t=LEVELS.indexOf(this.level);for(let e=max(0,t-1);e<min(LEVELS.length,t+2);e++)wrap(()=>{translate(400,this.levelY(LEVELS[e])),LEVELS[e].render()})}),this.menu&&wrap(()=>this.menu.render())}}onload=(()=>{onresize(),CANVAS.width=1600,CANVAS.height=800,R=CANVAS.getContext("2d"),Object.getOwnPropertyNames(canvasProto).forEach(t=>{R[t].call&&(w[t]=canvasProto[t].bind(R))}),console.log("LOADED"),new Game;let t=Date.now(),e=()=>{let i=Date.now(),s=min((i-t)/1e3,100);t=i,G.cycle(s),requestAnimationFrame(e)};e()});</script>